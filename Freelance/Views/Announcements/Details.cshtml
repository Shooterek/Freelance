@using Freelance.Infrastructure.ViewModels
@using Microsoft.AspNet.Identity
@model AnnouncementViewModel

@{
    bool isAuthenticatedAndNotAdvertiser = Context.User.Identity.IsAuthenticated && !Context.User.Identity.GetUserId().Equals(Model.AdvertiserId);
}

<div class="row blue-strip">
    <div class="col-md-10 col-md-offset-1">
        <section id="header">
            <div class="col-sm-8">
                <h2><b>@Model.Title</b></h2>
            </div>
            <div class="col-sm-4 center">
                <h2><b>Stawka: @Model.ExpectedHourlyWage zł</b></h2>
            </div>
        </section>
    </div>
</div>

<div class="spacer"></div>
<div class="row">
    <div class="col-md-7 col-sm-12 col-md-offset-1">
        <div class="row">
            <div class="col-sm-12 white-background">
                <h3>Opis</h3>
                <p class="user-content">
                    @Model.Description
                </p>
                <div class="spacer"></div>

                @if (Model.Photos.Count > 0)
                {
                    <h4>Załączone zdjęcia</h4>
                    <div class="preview-area">
                        @foreach (var photo in Model.Photos)
                        {
                            <img id=@photo.PhotoId class="img-responsive preview"
                                 src="@String.Format("data:{0};base64,{1}", photo.ContentType, Convert.ToBase64String(photo.Content))"/>
                            <div id=@("photo" + photo.PhotoId) class="modal fade">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                        <div class="modal-body">
                                            <img class="img-responsive " src="@String.Format("data:{0};base64,{1}", photo.ContentType, Convert.ToBase64String(photo.Content))"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        <div class="spacer"></div>
                    </div>
                }
                <div class="spacer"></div>
                @if (Model.Offers.Any())
                {
                    <hr/>
                    <div class="row">
                        <div class="col-sm-12">
                            <h4>
                                Złożone oferty
                            </h4>
                            <div>
                                @Html.Partial("OffersList", new AnnouncementOffersListViewModel {Offers = Model.Offers, ShowAll = false})
                            </div>
                        </div>
                    </div>
                }

                @if (Context.User.Identity.IsAuthenticated && Context.User.Identity.GetUserId() != Model.AdvertiserId)
                {
                    <br/>
                    <div class="row">
                        <div class="col-sm-12">
                            <h4>
                                Dodaj ofertę
                            </h4>
                            <div>
                                @Html.Action("AddOffer", new {announcementId = Model.AnnouncementId})
                            </div>
                        </div>
                    </div>
                    <div class="spacer"></div>
                }
            </div>
        </div>
    </div>
    <div class="col-md-3 hidden-sm hidden-xs">
        <div class="col-sm-12 details white-background">
            <div class="spacer"></div>
            <img class="img-responsive" width="120" height="120" 
                 src="@(Model.Advertiser.Photo != null ? String.Format("data:{0};base64,{1}", Model.Advertiser.Photo.ContentType, Convert.ToBase64String(Model.Advertiser.Photo.Content)) 
                            : "http://stjohntruck.com/wp-content/uploads/2018/01/person-placeholder.jpg")"/>
            <p>@Model.Advertiser.UserName</p>
            <div class="@(isAuthenticatedAndNotAdvertiser && Model.Advertiser.ReceivedOpinions.Any() ? "rating pointer" : "rating")">
                @if (Model.Advertiser.ReceivedOpinionsCount > 0)
                {
                    int i = 1;
                    for (; i <= Model.Advertiser.ReceivedOpinionsAverage; i++)
                    {
                        <i class="fa fa-star"></i>
                    }
                    if (Model.Advertiser.ReceivedOpinionsAverage - i + 1 >= 0.25 && Model.Advertiser.ReceivedOpinionsAverage - i + 1 < 0.75)
                    {
                        <i class="fa fa-star-half"></i>
                    }
                    else if (Model.Advertiser.ReceivedOpinionsAverage - i + 1 >= 0.75)
                    {
                        <i class="fa fa-star"></i>
                    }
                    <span>(@Model.Advertiser.ReceivedOpinionsCount ocen)</span>
                }
                else
                {
                    <span>Brak ocen</span>
                }
            </div>
        </div>
    </div>
</div>

@if (Model.Advertiser.ReceivedOpinions.Any())
{
    <div class="modal fade modal-fullscreen-xs-down" id="opinionsModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Opinie o @Model.Advertiser.UserName</h4>
                </div>
                <div class="modal-body">
                    @Html.Partial("OpinionsList", Model.Advertiser.ReceivedOpinions)
                </div>
            </div>
        </div>
    </div>
}